{%- macro playerAbilityParams(ability, defaultTarget=null) -%}
    {%- if ability.targetPlayer and ability.targetPlayer !== defaultTarget -%}
(context) => ({
        {%- if ability.targetPlayer === 'self' -%}
    target: context.player,
        {%- else -%}
    target: context.player.opponent,
        {%- endif -%}
    amount: {{ability.quantity}}
    {%- else -%}
{{ability.quantity}}
    {%- endif -%}
{%- endmacro -%}

{%- macro singleCondition(condition) -%}
    {%- if condition.name == "not" -%}
!{{singleCondition(condition.condition)}}
    {%- elif condition.name == "trait" -%}
card.hasTrait('{{condition.trait}}')
    {%- elif condition.name == "house" -%}
card.hasHouse('{{condition.house}}')
    {%- else -%}
/*{{ effect | dump(2) | safe}}*/
    {%- endif -%}
{%- endmacro -%}

{%- macro cardCondition(effect) -%}
{%- set l = [] -%}
{%- if effect.name == 'use' -%} {# Is this required, or inbuilt anyway? #}
    {% set l = l.concat(['card.exhausted === false']) %}
{%- endif -%}
{%- for c in effect.target.conditions -%}
    {% set l = l.concat(singleCondition(c)) %}
{%- endfor -%}
{%- if l.length > 0 -%}
    cardCondition: (card) => {{ l | join(' && ') | safe }},
{% endif -%}
{%- endmacro -%}

{%- macro effectMacro(effect) -%}
{{ cardCondition(effect) }}
    {%- if effect.name == 'gainAmber' -%}
gameAction: ability.actions.gainAmber({{ playerAbilityParams(effect, defaultTarget='you') }})
    {%- elif effect.name == 'captureAmber' -%}
gameAction: ability.actions.capture({{ playerAbilityParams(effect, defaultTarget='you') }})
    {%- elif effect.name == 'stealAmber' -%}
gameAction: ability.actions.steal({{ playerAbilityParams(effect, defaultTarget='you') }})
    {%- elif effect.name == 'loseAmber' -%}
gameAction: ability.actions.loseAmber({{ playerAbilityParams(effect, defaultTarget='opponent') }})
    {%- elif effect.name == 'dealDamage' -%}
gameAction: ability.actions.dealDamage({ amount: {{effect.quantity}} })
    {%- elif effect.name == 'use' -%}
gameAction: ability.actions.use()
    {%- elif effect.name == 'ready' -%}
gameAction: ability.actions.ready()
    {%- elif effect.name == 'readyAndUse' -%}
gameAction: ability.actions.sequential([
    ability.actions.ready(),
    ability.actions.use()
])
    {%- elif effect.name == 'readyAndFight' -%}
gameAction: ability.actions.sequential([
    ability.actions.ready(),
    ability.actions.fight()
])
    {%- else -%}
        /*{{ effect | dump(2) | safe}}*/
    {%- endif -%}
{%- endmacro -%}

{%- macro targetMacro(target) -%}
{%- if target.type != null -%}
cardType: '{{target.type}}',
{% endif -%}
{%- if target.controller != null -%}
controller: '{{target.controller}}',
{% endif -%}
{%- endmacro -%}

{%- macro abilityMacro(ability) -%}
    {%- if (ability.name == 'bold') -%}
        {%- if ability.trigger == 'Reap' -%}
this.reap({
        {%- elif ability.trigger == 'Fight' -%}
this.fight({
        {%- elif ability.trigger == 'Destroyed' -%}
this.destroyed({
        {%- elif ability.trigger == 'Play'-%}
this.play({
        {%- elif ability.trigger == 'Omni'-%}
this.omni({
        {%- elif ability.trigger == 'Before Fight'-%}
this.beforefight({
        {%- elif ability.trigger == 'Action'-%}
this.action({
        {%- else -%}
this.unknown( //{{ ability.trigger }}
        {%- endif %}
        {%- for extraTrigger in ability.extraTriggers %}
    {{extraTrigger | lower}}: true,
        {%- endfor %}
    {%- if ability.effect.target != null %}
    target: {
        {{targetMacro(ability.effect.target) | indent(8) -}}
        {{ effectMacro(ability.effect) | indent(8)}}
    }
    {%- else %}
    {{ effectMacro(ability.effect) | indent(4)}}
    {%- endif %}
});
    {%- elif ability.name == 'keywords' -%}
//Keywords: {{ ability.keywords.join(", ") }}
    {%- else -%}
        /*{{ ability | dump(2) | safe}}*/
    {%- endif -%}
{%- endmacro -%}

const Card = require('../../Card.js');

class {{ name }} extends Card {
    setupCardAbilities(ability) {
        {%- for ability in abilities %}
        {{abilityMacro(ability) | indent(8)}}
        {%- endfor %}
    }
}

{{name}}.id = '{{card.id}}';

module.exports = {{name}};
