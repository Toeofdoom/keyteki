{%- import "Condition.njk" as Condition -%}

{# Formats any type of ability#}
{%- macro formatAbility(ability, refs) -%}
{%- if (ability.name == 'bold') -%}
this.{{ability.trigger}}({{boldAbility(ability, refs)}});
{%- elif (ability.name == 'persistentEffect') -%}
    {%- if ability.target.mode == "this"-%}
this.whileAttached({
    {{persistentEffect(ability, refs | upgradeRefs, false) | indent(4)}}
});
    {%- else -%}
this.persistentEffect({
    {{persistentEffect(ability, refs) | indent(4)}}
});
    {%- endif -%}
{%- elif ability.name == 'reaction' -%}
this.reaction({
    {{formatReaction(ability, refs) | indent(4)}}
});
{%- elif ability.name == 'keywords' -%}
//Keywords: {% for k in ability.keywords -%}
{{k.name}}{{" " + k.count if k.count != null}}{{", " if not loop.last}}
    {%- endfor %}
{%- else -%}
/*{{ ability | dump(2) }}*/
{%- endif -%}
{%- endmacro -%}

{# Bold abilities - these have simple triggers and often have targets. #}
{%- macro boldAbility(ability, refs) -%}
{
{%- for extraTrigger in ability.extraTriggers %}
    {{extraTrigger | lower}}: true,
{%- endfor %}
    {{formatEffects(ability.effect | sortEffects, refs) | indent(4)}}
}
{%- endmacro -%}

{# Persistent effects - WIP #}
{%- macro persistentEffect(ability, refs, controllable=true) -%}
{%- set targetController = (ability.target.controller or 'any')
    if (ability.target and ability.target.mode == 'all')
    else (ability.targetPlayer or 'any') -%}
{%- if ability.effects[0].name.includes("entersPlay") -%}
location: 'any',
{% elif targetController != 'self' and controllable -%}
targetController: '{{targetController}}',
{% endif -%}
{%- set c = Condition.cardConditionInternal(ability.target, refs) -%}
{%- if c.length > 0 -%}
match: (card{{", context" if c.includes("context") }}) => {{c}},
{% endif -%}
effect: {{formatEffectArray(ability.effects, refs) }}
{%- endmacro -%}

{# Sorts out effects that may be targetted or untargeted, sequential or interdependent. 

 The rule regarding resolving one sentence at a time, except for damage and replacement effects etc. is not implemented yet - and many existing cards don't follow it anyway. In particular, this doesn't generate any unconditional "thens" using alwaysTriggers #}
{%- macro formatEffects(effects, refs) -%}
{%- set j = joiner(",\n") -%}
{# Targetted effects #}
{%- if effects.optional -%}
{{j()}}optional: true
{%- endif -%}
{%- if effects.condition -%}
{{j()}}{{- Condition.formatCondition(effects.condition, refs) -}}
{%- endif -%}
{%- if effects.targets.length > 1 -%}
{{j()}}targets: {
{%- for target in effects.targets %}
    target{{loop.index}}: {
        {{formatTarget(target, refs) | indent(8) }}
    }{{"," if not loop.last }}
{%- endfor %}
}
{%- elif effects.targets.length == 1 -%}
{{j()}}target: {
    {{formatTarget(effects.targets[0], refs) | indent(4) }}
}
{%- endif -%}
{# Untargetted effects #}
{%- if effects.default.length > 0 -%}
{{- j()}}gameAction: {{formatEffectArray(effects.default, refs)}}
{%- endif -%}
{# Dependent effects #}
{%- if effects.then != null-%}
{{ j()}}then: {% call provideParameters(refs.thenContext) %}{
    {%- if effects.then.alwaysTriggers %}
    alwaysTriggers: true,
    {%- endif %}
    {{formatEffects(effects.then, refs | then | itIs(refs.thenContext + '.target')) | indent(4) }}
}
{%- endcall %}
{%- endif -%}
{# Stuff we can't format yet #}
{%- for unknownEffect in effects.unknown %}
/*Unsupported combinations: {{unknownEffect | dump(2) }}*/
{%- endfor -%}
{%- endmacro -%}

{%- macro formatEffectArray(effects, refs) -%}
{%- if effects.length > 1 -%}
[
    {%- for e in effects %}
    {{ formatSingleEffect(e, refs) | indent(4) }}{{"," if not loop.last }}
    {%- endfor %}
]
{%- elif effects.length == 1 -%}
{{ formatSingleEffect(effects[0], refs) }}
{%- endif %}
{%- endmacro -%}

{# Targetting options setup #}
{%- macro formatTarget(effect, refs) -%}
{%- set j = joiner(',\n') -%}
{%- if effect.target.mode != "exactly" -%}
{{j()}}mode: '{{effect.target.mode}}'
{%- endif -%}
{%- if effect.target.count != 1 and effect.target.count != null -%}
{{j()}}numCards: '{{effect.target.count}}'
{%- endif -%}
{%- if effect.target.type != null -%}
{{j()}}cardType: '{{effect.target.type}}'
{%- endif -%}
{%- if effect.target.controller != null -%}
{{j()}}controller: '{{effect.target.controller}}'
{%- endif -%}
{%- if effect.target.location != null -%}
{{j()}}location: '{{effect.target.location}}'
{%- endif -%}
{%- if effect.target.cardStat -%}
{{j()}}cardStat: (card) => {{Condition.formatQuantity(effect.target.cardStat, refs)}}
{%- endif -%}
{%- set c = Condition.cardConditionInternal(effect.target, refs | filteredType(effect.target.type), effect) -%}
{%- if c.length > 0 -%}
{{j()}}cardCondition: (card{{", context" if c.includes("context") }}) => {{ c }}
{%- endif -%}
{%- if effect.name -%}
{{j()}}gameAction: {{formatSingleEffect(effect, refs)}}
{%- endif -%}
{%- endmacro -%}

{# Individual effect implementations - mostly just calls the matching function, but
there are some exceptions. #}
{%- macro formatSingleEffect(effect, refs) -%}
    {%- if ['gainAmber','stealAmber','gainChains','draw'].includes(effect.name) -%}
ability.actions.{{effect.name}}({{ formatParams(effect, refs, defaultPlayerTarget='self') }})
    {%- elif ['loseAmber', 'discardAtRandom'].includes(effect.name) -%}
ability.actions.{{effect.name}}({{ formatParams(effect, refs, defaultPlayerTarget='opponent') }})
    {%- elif effect.name == 'gainAbility' -%}
        {%- if effect.ability.name == 'bold' -%}
ability.effects.gainAbility('{{effect.ability.trigger}}', {{ boldAbility(effect.ability, refs) }})
        {%- endif -%}
    {%- elif effect.name == 'gainKeywords' -%}
ability.effects.addKeyword({ 
        {%- for keyword in effect.keywords %}
    {{keyword.name}}: {{keyword.count|default(1, true)}}{{"," if not loop.last }}
        {%- endfor %}
})
    {%- elif effect.name == 'sequential' -%}
ability.actions.sequential([
        {%- for action in effect.actions %}
    {{formatSingleEffect(action, refs) | indent(4)}}{{"," if not loop.last }}
        {%- endfor %}
])
    {%- elif ['forRemainderOfTurn', 'lastingEffect'].includes(effect.name) -%}
        {%- if effect.durationEffect.name == "reaction" or not effect.durationEffect.target -%}
ability.actions.{{effect.name}}({{formatParams(effect, refs, allowContext=false)}})
        {%- else -%}
ability.actions.cardLastingEffect({{formatParams(effect.durationEffect, refs)}})
        {%- endif -%}
    {%- elif ['entersPlayReady', 'entersPlayStunned'].includes(effect.name) -%}
ability.effects.{{effect.name}}()
    {%- elif ['modifyPower', 'modifyArmor', 'modifyKeyCost'].includes(effect.name) -%}
ability.effects.{{effect.name}}({{effect.amount}})
    {%- elif effect.name == 'unknown' or not effect.name -%}
/*{{effect | dump(2) }}*/
    {%- else -%}
ability.actions.{{effect.name}}({{formatParams(effect, refs)}})
    {%- endif -%}
{%- endmacro -%}

{# Parameters #}
{%- macro formatParams(ability, refs, defaultPlayerTarget=null, allowContext=true) -%}
{%- set params = formatParamsInternal(ability, refs, defaultPlayerTarget) -%}
{%- if params.includes("context") and allowContext -%}
(context) => ({
    {{ params | indent(4) }}
})
{%- elif params.includes("\n") -%}{#- This type of check only works at the lowest level.-#}
{
    {{ params | indent(4) }}
}
{%- elif params.length > 0 -%}
{ {{ params }} }
{%- endif -%}
{%- endmacro -%}

{%- macro whenTriggers(trigger, refs) -%}
{%- if trigger.trigger == "reap" -%}
onReap: {{Condition.eventCondition(trigger, refs | check('event.card'))}}
{%- elif trigger.trigger == "play" -%}
onCardPlayed: {{Condition.eventCondition(trigger, refs | check('event.card'))}}
{%- elif trigger.trigger == "fight" -%}
onFight: {{Condition.eventCondition(trigger, refs | check('event.attacker'))}}
{%- elif trigger.trigger == "destroyed" -%}
onCardDestroyed: {{Condition.eventCondition(trigger, refs | check('event.clone'))}}
{%- elif trigger.trigger == "forges" -%}
onForgeKey: {{Condition.eventCondition(trigger, refs)}}
{%- elif trigger.trigger == "use" -%}
onAbilityResolved: {{Condition.eventCondition(trigger, refs | check('event.card'))}} && 
    event.context.ability.isAction() &&
    !event.context.ability.isCardPlayed()
{%- else -%}
/*{{trigger | dump(2)}}*/
{%- endif -%}
{%- endmacro-%}

{%- macro formatParamsInternal(ability, refs, defaultPlayerTarget=null) -%}
{%- set j = joiner(',\n') -%}
{%- if ability.target != null and not (ability | isTargetted) -%}
{{j()}}target: {{formatAutomaticTarget(ability.target, refs)}}
{%- endif -%}
{%- if ability.durationEffect != null -%}
    {%- if ability.durationEffect.name == "reaction" -%}
{{formatReaction(ability.durationEffect, refs)}}
    {%- elif ability.durationEffect.name == "persistentEffect" -%}
{{persistentEffect(ability.durationEffect, refs)}}
    {%- else -%}
/* {{ability.durationEffect | dump(2)}} */
    {%- endif -%}
{%- endif -%}
{%- if ability.amount == 'all' -%}
{{j()}}all: true
{%- elif ability.amount != null -%}
{{j()}}amount: {{ability.amount}}
{%- endif -%}
{%- if ability.splash != null -%}
{{j()}}splash: {{ability.splash}}
{%- endif -%}
{%- if ability.location != null -%}
{{j()}}location: '{{ability.location}}'
{%- endif -%}
{%- if ability.fully == true -%}
{{j()}}fully: true
{%- endif -%}
{%- set targetPlayer = ability.targetPlayer if ability.targetPlayer else 'self' -%}
{%- if defaultPlayerTarget != null and targetPlayer !== defaultPlayerTarget -%}
{{j()}}target: {{formatPlayer(targetPlayer, refs)}}
{%- endif -%}
{%- if ability.player != null -%}
{{j()}}player: {{formatPlayer(ability.player, refs)}}
{%- endif -%}
{%- if ability.effects != null -%}
{{j()}}effect: {{formatEffectArray(ability.effects, refs) }}
{%- endif -%}
{%- endmacro -%}

{%- macro formatAutomaticTarget(target, refs) -%}
{%- if target.mode == "all" -%}
    {%- if target.location == null or target.location == "play area" -%}
        {%- if target.type == "creature" -%}
context.game.creaturesInPlay{{Condition.cardFilter(target, refs | filteredType('creature'))}}
        {%- else -%}
context.game.cardsInPlay{{Condition.cardFilter(target, refs)}}
        {%- endif -%}
    {%- elif target.location == "discard" -%}
{{formatPlayer(target.controller, refs)}}.discard{{Condition.cardFilter(target, refs)}}
    {%- else -%}
/*{{target.location}}*/{{Condition.cardFilter(target, refs)}}
    {%- endif -%}
{%- elif target.mode == "self" -%}
{{refs.this}}
{%- elif target.mode == "this" -%}
context.source
{%- elif target.mode == "it" -%}
{{refs.it}}
{%- else -%}
/* {{target | dump}} */
{%- endif -%}
{%- endmacro -%}

{% macro formatPlayer(targetPlayer, refs) %}
{%- if targetPlayer === 'self' -%}
context.player
{%- elif targetPlayer === 'opponent' -%}
context.player.opponent
{%- elif targetPlayer === 'owner' -%}
{{refs.it}}.owner
{%- elif targetPlayer === 'ownerOpponent' -%}
{{refs.it}}.owner.opponent
{%- elif targetPlayer === 'controller' -%}
{{refs.it}}.controller
{%- elif targetPlayer === 'controllerOpponent' -%}
{{refs.it}}.controller.opponent
{%- elif targetPlayer === 'they' -%}
context.player.opponent{# TODO: make this refer to something in refs. #}
{%- else -%}
/* {{targetPlayer | dump}} */
{%- endif -%}
{% endmacro %}

{%- macro formatReaction(reaction, refs) -%}
when: {
    {{whenTriggers(reaction.trigger, refs) | indent(4)}}
},
{% if reaction.trigger.trigger == "fight" -%}
{{formatEffects(reaction.effect | sortEffects, refs | itIs('context.event.attacker'))}}
{%- elif reaction.trigger.trigger == "destroyed" -%}
{{formatEffects(reaction.effect | sortEffects, refs | itIs('context.event.clone'))}}
{%- else -%}
{{formatEffects(reaction.effect | sortEffects, refs | itIs('context.event.card'))}}
{%- endif-%}
{%- endmacro -%}

{%- macro provideParameters(parameter) -%}
{% if caller().includes(parameter) -%}
({{parameter}}) => ({{caller()}})
{%- else -%}
{{caller()}}
{%- endif -%}
{%- endmacro -%}
